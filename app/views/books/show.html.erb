<div class="card">
  <h1><%= @book.title %></h1>
  
  <p><strong>Authors:</strong> 
    <%= @book.authors.map { |a| link_to a.name, a }.join(", ").html_safe %>
  </p>
  
  <p><strong>ISBN:</strong> <%= @book.isbn || "N/A" %></p>
  <p><strong>Published:</strong> <%= @book.publication_year %></p>
  
  <p><strong>Categories:</strong> 
    <%= @book.categories.map { |c| link_to c.name, c }.join(", ").html_safe %>
  </p>
  
  <p><strong>Total Copies:</strong> <%= @book.total_copies %></p>
  <p><strong>Available:</strong> <%= @book.available_copies %></p>
  
  <% if @book.average_rating %>
    <p class="star-rating">
      <%= "â­" * @book.average_rating.round %>
      Average Rating: <%= @book.average_rating.round(1) %>/5 
      (<%= @book.reviews_count %> reviews)
    </p>
  <% end %>
  
  <h3>Description</h3>
  <p><%= @book.description || "No description available." %></p>
  
    <div style="margin-top: 20px;">
    <% if @book.available? %>
        <%= link_to "ðŸ“– Borrow This Book", borrow_book_path(@book), 
            data: { turbo_method: :post }, class: "btn btn-success" %>
    <% else %>
        <%= link_to "ðŸ”– Reserve This Book", reserve_book_path(@book), 
            data: { turbo_method: :post }, class: "btn" %>
    <% end %>
    </div>
  
<div style="margin-top: 20px;">
  <%= link_to "Edit", edit_book_path(@book), class: "btn" %>
  <%= link_to "Delete", @book, data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
      class: "btn btn-danger" %>
</div>
</div>

<div class="card">
  <h2>Reviews (<%= @reviews.count %>)</h2>
  
  <% if logged_in? && !current_user.reviews.exists?(reviewable: @book) %>
    <h3>Write a Review</h3>
    <%= form_with model: [@book, @review] do |f| %>
      <div class="form-group">
        <%= f.label :rating, "Rating (1-5 stars)" %>
        <%= f.select :rating, (1..5).to_a.reverse, {}, { required: true } %>
      </div>
      
      <div class="form-group">
        <%= f.label :comment, "Your Review" %>
        <%= f.text_area :comment, required: true %>
      </div>
      
      <%= f.submit "Submit Review", class: "btn" %>
    <% end %>
  <% end %>
  
  <% if @reviews.any? %>
    <% @reviews.each do |review| %>
      <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px;">
        <p><strong><%= review.user.name %></strong> 
          <span class="star-rating"><%= "â­" * review.rating %></span>
        </p>
        <p><%= review.comment %></p>
        <p style="font-size: 0.85em; color: #666;">
          <%= review.created_at.strftime("%B %d, %Y") %>
        </p>
        
        <% if librarian? && review.status == 'pending' %>
          <%= link_to "Approve", approve_review_path(review), 
              data: { turbo_method: :patch }, class: "btn btn-success" %>
          <%= link_to "Flag", flag_review_path(review), 
              data: { turbo_method: :patch }, class: "btn btn-danger" %>
        <% end %>
        
        <% if current_user == review.user %>
          <%= link_to "Delete", book_review_path(@book, review), 
              data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
              class: "btn btn-danger" %>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p style="margin-top: 20px;">No reviews yet. Be the first to review!</p>
  <% end %>
</div>